# Лабораторная работа 2
## Вариант(medium): мини-оболочка с архивами, grep и undo

* **Цель:** Реализовать интерактивную файловую оболочку на Python с историей, логированием, архивированием и откатом критичных команд.
* **Библиотеки:** os, shlex, stat, shutil, re, tarfile, zipfile, logging, pathlib, datetime, typer, pyfakefs.
* **Допущения:**
  - Обработка аргументов выполняется через `shlex`, поэтому стандартные кавычки и экранирование работают.
  - Встроенные команды выполняются только в пределах файловой системы.
  - При удалении каталогов требуется подтверждение в интерактивном режиме.
  - Архивация пропускает скрытый служебный каталог `.git`.
  - Undo доступен только для `cp`, `mv`, `rm` и выполняется, пока не будут очищены накопленные действия.
* **Чему я научился:**
    - Создавать REPL-системы и настраивать CLI через Typer.
    - Логировать команды в формате, приближенном к системным шеллам.
    - Работать с ZIP/TAR-архивами и безопасно распаковывать их.
    - Хранить историю между запусками и реализовывать undo-стек.

## Основные команды
- `cd [path]` — переход в каталог (без аргумента возвращает в `~`).
- `ls [-l] [path]` — список файлов; ключ `-l` показывает права, размер и дату.
- `cat <file>` — выводит содержимое файла с допуском к текстам UTF-8.
- `cp [-r] <source> <destination>` — копирует файлы и каталоги (`-r` обязателен для директорий).
- `mv <source> <destination>` — перемещает/переименовывает, с записью в undo.
- `rm [-r] <path>` — перемещает файлы в `.trash`; каталоги удаляются только после подтверждения.
- `pwd` — показывает текущий каталог оболочки.
- `history [N]` — печатает последние команды из `history.log` (по умолчанию 10).
- `undo` — возвращает результат последнего `cp`, `mv` или `rm`.
- `zip <folder> <archive.zip>` / `unzip <archive.zip>` — архивирование и распаковка ZIP.
- `tar <folder> <archive.tar.gz>` / `untar <archive.tar.gz>` — работа с TAR.GZ.
- `grep [-r] [-i] <pattern> <path>` — поиск по содержимому с рекурсией и регистронезависимостью.
- `help` — короткая сводка доступных команд.
- `exit` — завершает работу оболочки.

## Как всё устроено
1. Старт выполняется через `Typer`: команда `run` создаёт экземпляр `Shell` и запускает REPL.
2. Перед первым запросом готовятся служебные файлы: `shell.log`, `history.log`, каталог `.trash`, undo-стек.
3. Каждая введённая строка:
   - сохраняется в `history.log`;
   - логируется в `shell.log` c временной меткой (`[YYYY-MM-DD HH:MM:SS] команда`).
4. Строка разбирается `shlex.split`, выбирается хэндлер из словаря зарегистрированных команд.
5. Команда выполняется в контексте текущего каталога оболочки (`shell.cwd`), при необходимости сохраняя данные для `undo`.
6. В случае успеха вывод окрашивается в зелёный цвет; ошибки попадают в красную рамку и фиксируются в логе (`ERROR: …`).
7. Оболочка реагирует на `Ctrl+D`/`Ctrl+C`, завершая работу с записью в лог.

### Логирование и история
- `shell.log` — последовательность выполненных команд и ошибок, например:
  ```
  [2025-11-01 18:43:48] ls -l ./data
  [2025-11-01 18:43:48] ERROR: ls: cannot access './data': No such file or directory
  ```
- `history.log` — чистый список команд, используемый командой `history`.
- `.trash/` — временное хранилище удалённых объектов для дальнейшего `undo`.

## Инструкция к использованию

### Установить зависимости
```
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt
```

### Запустить оболочку
```
python3 -m src.main
```

### Запустить тесты
```
python3 -m pytest
```

Тесты используют `pyfakefs` для изоляции работы с файловой системой и проверяют ключевые сценарии архивирования и ошибок.
